# Погодный Агент (OpenAI Tools API)

ИИ-ассистент для получения информации о погоде, демонстрирующий использование **стандартного OpenAI Tools API** для вызова функций. В отличие от наивного текстового парсинга, этот проект использует встроенный механизм function calling.

## Возможности

- Текущие погодные условия для любого города мира
- Прогноз погоды до 7 дней
- Многоходовые диалоги с сохранением сессии
- Веб-интерфейс чата

## Архитектура

### Агентный цикл (Agentic Loop)

Агент реализует **агентный цикл** — паттерн, при котором LLM может запрашивать выполнение инструментов и получать результаты перед генерацией финального ответа.

```text
┌─────────────────────────────────────────────────────────────────┐
│                       АГЕНТНЫЙ ЦИКЛ                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Пользователь: "Какая погода в Москве?"                         │
│           │                                                     │
│           ▼                                                     │
│  ┌─────────────────┐                                            │
│  │ Собрать контекст│  [системный промпт + история диалога]      │
│  └────────┬────────┘                                            │
│           │                                                     │
│           ▼                                                     │
│  ┌─────────────────┐                                            │
│  │   Вызвать LLM   │  + передать tools=[...]                    │
│  └────────┬────────┘                                            │
│           │                                                     │
│           ▼                                                     │
│  ┌─────────────────┐     Да     ┌──────────────────┐            │
│  │ Есть tool_calls │──────────▶ │ Извлечь вызовы   │            │
│  │ в ответе?       │            │ из response      │            │
│  └────────┬────────┘            └────────┬─────────┘            │
│           │ Нет                          │                      │
│           │                              ▼                      │
│           │                     ┌──────────────────┐            │
│           │                     │Выполнить инстр-т │            │
│           │                     │  (Weather API)   │            │
│           │                     └────────┬─────────┘            │
│           │                              │                      │
│           │                              ▼                      │
│           │                     ┌──────────────────┐            │
│           │                     │Добавить tool msg │            │
│           │                     │с результатом     │            │
│           │                     └────────┬─────────┘            │
│           │                              │                      │
│           │              ┌───────────────┘                      │
│           │              │ (вернуться в цикл)                   │
│           │              ▼                                      │
│           │      ┌─────────────────┐                            │
│           │      │   Вызвать LLM   │                            │
│           │      └────────┬────────┘                            │
│           │               │                                     │
│           ▼               ▼                                     │
│  ┌─────────────────────────────────────┐                        │
│  │       Вернуть финальный ответ       │                        │
│  │  "В Москве сейчас -5°C, ясно..."    │                        │
│  └─────────────────────────────────────┘                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Рост контекста в цикле

Каждая итерация добавляет сообщения в контекст:

```text
Итерация 1:
  [0] SYSTEM: Ты — погодный ассистент...
  [1] USER: Какая погода в Москве?

  LLM отвечает с tool_calls: [get_current_weather(location="Moscow")]

Итерация 2:
  [0] SYSTEM: Ты — погодный ассистент...
  [1] USER: Какая погода в Москве?
  [2] ASSISTANT: (с tool_calls)
  [3] TOOL: {"location": "Moscow, Russia", "temperature_celsius": -5, ...}

  LLM отвечает: В Москве сейчас морозно... (нет tool_calls = конец)
```

### Стандартный OpenAI Tools API

Проект использует **официальный OpenAI function calling API**, что обеспечивает:

**Определение инструментов** (`app/tools.py`):

```python
TOOLS = [
    {
        "type": "function",
        "function": {
            "name": "get_current_weather",
            "description": "Получить текущую погоду для города",
            "parameters": {
                "type": "object",
                "properties": {
                    "location": {
                        "type": "string",
                        "description": "Название города"
                    }
                },
                "required": ["location"]
            }
        }
    }
]
```

**Вызов API** (`app/services.py`):

```python
response = client.chat.completions.create(
    model=OPENAI_MODEL,
    messages=messages,
    tools=tools.get_tools(),  # Передаём определения инструментов
)

# API автоматически парсит tool_calls
if response.choices[0].message.tool_calls:
    for tool_call in response.choices[0].message.tool_calls:
        result = await execute_tool(tool_call.function.name,
                                    json.loads(tool_call.function.arguments))
        messages.append({
            "role": "tool",
            "tool_call_id": tool_call.id,
            "content": result
        })
```

**Преимущества стандартного подхода:**

- Структурированные JSON-схемы для определения инструментов
- API сам парсит и валидирует аргументы
- Типизация параметров (string, integer, enum и т.д.)
- Легко расширять новыми инструментами
- Надёжная работа без regex-хаков

### Структура проекта

```text
05-weather-agent-tools/
├── app/
│   ├── config.py      # Конфигурация окружения
│   ├── database.py    # Хранение сессий/сообщений в SQLite
│   ├── models.py      # Pydantic модели запросов/ответов
│   ├── routes.py      # API эндпоинты FastAPI
│   ├── services.py    # Интеграция с LLM и агентный цикл
│   ├── tools.py       # Определение и выполнение инструментов
│   └── weather.py     # Интеграция с Open-Meteo API
├── static/
│   └── index.html     # Веб-интерфейс чата
├── main.py            # Точка входа FastAPI
├── system_prompt.txt  # Промпт агента
└── pyproject.toml     # Зависимости проекта
```

## Установка

1. Установить зависимости:

   ```bash
   uv sync
   ```

2. Настроить переменные окружения в `.env`:

   ```text
   OPENAI_API_KEY=your-api-key
   OPENAI_API_URL=https://api.openai.com/v1  # или другой совместимый API
   OPENAI_MODEL=gpt-4o-mini
   ```

3. Запустить сервер:

   ```bash
   uv run python main.py
   ```

4. Открыть <http://localhost:8000>

## API эндпоинты

| Эндпоинт                       | Метод | Описание                    |
| ------------------------------ | ----- | --------------------------- |
| `/api/sessions`                | POST  | Создать новую сессию        |
| `/api/sessions/{id}/messages`  | POST  | Отправить сообщение         |
| `/api/sessions/{id}/end`       | POST  | Завершить сессию            |
| `/api/sessions`                | GET   | Список всех сессий          |
| `/api/sessions/{id}`           | GET   | Детали сессии               |

## Примеры запросов

- "Какая погода в Токио?"
- "Дай прогноз на 5 дней для Парижа"
- "Сейчас идёт дождь в Лондоне?"
- "Сравни погоду в Нью-Йорке и Лос-Анджелесе"

## Weather API

Используется [Open-Meteo](https://open-meteo.com/) — бесплатный API погоды, не требующий ключа.
