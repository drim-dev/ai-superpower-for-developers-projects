# Погодный Агент

ИИ-ассистент для получения информации о погоде, демонстрирующий **ручную реализацию протокола инструментов** в учебных целях. Вместо использования встроенных API для вызова функций, проект парсит вызовы инструментов напрямую из текстовых ответов LLM.

## Возможности

- Текущие погодные условия для любого города мира
- Прогноз погоды до 7 дней
- Многоходовые диалоги с сохранением сессии
- Веб-интерфейс чата

## Архитектура

### Агентный цикл (Agentic Loop)

Агент реализует **агентный цикл** — паттерн, при котором LLM может запрашивать выполнение инструментов и получать результаты перед генерацией финального ответа.

```text
┌─────────────────────────────────────────────────────────────────┐
│                       АГЕНТНЫЙ ЦИКЛ                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Пользователь: "Какая погода в Москве?"                         │
│           │                                                     │
│           ▼                                                     │
│  ┌─────────────────┐                                            │
│  │ Собрать контекст│  [системный промпт + история диалога]      │
│  └────────┬────────┘                                            │
│           │                                                     │
│           ▼                                                     │
│  ┌─────────────────┐                                            │
│  │   Вызвать LLM   │                                            │
│  └────────┬────────┘                                            │
│           │                                                     │
│           ▼                                                     │
│  ┌─────────────────┐     Да     ┌──────────────────┐            │
│  │ Есть вызов      │──────────▶ │ Распарсить вызов │            │
│  │ инструмента?    │            │ Извлечь: Москва  │            │
│  │ [ПОГОДА: ...]?  │            └────────┬─────────┘            │
│  └────────┬────────┘                     │                      │
│           │ Нет                          ▼                      │
│           │                     ┌──────────────────┐            │
│           │                     │Выполнить инстр-т │            │
│           │                     │  (Weather API)   │            │
│           │                     └────────┬─────────┘            │
│           │                              │                      │
│           │                              ▼                      │
│           │                     ┌──────────────────┐            │
│           │                     │Форматировать рез.│            │
│           │                     │Добавить в контекст            │
│           │                     └────────┬─────────┘            │
│           │                              │                      │
│           │              ┌───────────────┘                      │
│           │              │ (вернуться в цикл)                   │
│           │              ▼                                      │
│           │      ┌─────────────────┐                            │
│           │      │   Вызвать LLM   │                            │
│           │      └────────┬────────┘                            │
│           │               │                                     │
│           ▼               ▼                                     │
│  ┌─────────────────────────────────────┐                        │
│  │       Вернуть финальный ответ       │                        │
│  │  "В Москве сейчас -5°C, ясно..."    │                        │
│  └─────────────────────────────────────┘                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Рост контекста в цикле

Каждая итерация добавляет сообщения в контекст:

```text
Итерация 1:
  [0] SYSTEM: Ты — погодный ассистент...
  [1] USER: Какая погода в Москве?

  LLM отвечает: [ПОГОДА: Moscow]

Итерация 2:
  [0] SYSTEM: Ты — погодный ассистент...
  [1] USER: Какая погода в Москве?
  [2] ASSISTANT: [ПОГОДА: Moscow]
  [3] USER: Результаты запросов:
            Температура: -5°C, Ясно...

  LLM отвечает: В Москве сейчас морозно... (нет вызова = конец)
```

### Наивный протокол инструментов

Проект использует **наивный ad-hoc подход** в учебных целях, демонстрируя, почему существуют структурированные протоколы.

**Формат:**

```text
[ПОГОДА: город]           → получить текущую погоду
[ПРОГНОЗ: город, дни]     → получить прогноз
```

**Реализация** (`app/tools.py`):

1. Системный промпт описывает доступные команды
2. LLM выводит команды в квадратных скобках
3. Regex парсит команды из текста ответа
4. Инструменты выполняются и возвращают результаты
5. Результаты отправляются обратно LLM как следующее сообщение
6. Цикл продолжается, пока в ответе есть команды

**Проблемы наивного подхода:**

- LLM может форматировать команды непоследовательно
- LLM может галлюцинировать данные вместо вызова инструментов
- Парсинг ломается на граничных случаях (спецсимволы, опечатки)
- Нет валидации параметров
- Сложно расширять новыми инструментами

### Структура проекта

```text
04-weather-agent/
├── app/
│   ├── config.py      # Конфигурация окружения
│   ├── database.py    # Хранение сессий/сообщений в SQLite
│   ├── models.py      # Pydantic модели запросов/ответов
│   ├── routes.py      # API эндпоинты FastAPI
│   ├── services.py    # Интеграция с LLM и агентный цикл
│   ├── tools.py       # Реализация протокола инструментов
│   └── weather.py     # Интеграция с Open-Meteo API
├── static/
│   └── index.html     # Веб-интерфейс чата
├── main.py            # Точка входа FastAPI
├── system_prompt.txt  # Промпт агента и инструкции по инструментам
└── pyproject.toml     # Зависимости проекта
```

## Установка

1. Установить зависимости:

   ```bash
   uv sync
   ```

2. Настроить переменные окружения в `.env`:

   ```text
   OPENAI_API_KEY=your-api-key
   OPENAI_API_URL=https://api.openai.com/v1  # или другой совместимый API
   OPENAI_MODEL=gpt-4o-mini
   ```

3. Запустить сервер:

   ```bash
   uv run python main.py
   ```

4. Открыть <http://localhost:8000>

## API эндпоинты

| Эндпоинт                       | Метод | Описание                    |
| ------------------------------ | ----- | --------------------------- |
| `/api/sessions`                | POST  | Создать новую сессию        |
| `/api/sessions/{id}/messages`  | POST  | Отправить сообщение         |
| `/api/sessions/{id}/end`       | POST  | Завершить сессию            |
| `/api/sessions`                | GET   | Список всех сессий          |
| `/api/sessions/{id}`           | GET   | Детали сессии               |

## Примеры запросов

- "Какая погода в Токио?"
- "Дай прогноз на 5 дней для Парижа"
- "Сейчас идёт дождь в Лондоне?"
- "Сравни погоду в Нью-Йорке и Лос-Анджелесе"

## Weather API

Используется [Open-Meteo](https://open-meteo.com/) — бесплатный API погоды, не требующий ключа.
